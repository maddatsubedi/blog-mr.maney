---
import Base from "@/layouts/Base.astro";
import Banner from "@/layouts/components/Banner.astro";
import Number from "@/layouts/components/number.astro";
import Preview from "@/components/preview.astro";
import PreviewBlog from "@/components/previewBlog.astro";
import Skills from "@/layouts/components/sections/Skills.astro";
import About from "@/layouts/components/sections/About.astro";
import ExploreCategories from "@/components/sections/ExploreCategories.astro";
import { getEntryBySlug } from "astro:content";
import SocialLinks from "@/components/SocialLinks.astro";
import SocialMediaPosts from "@/components/socialMediaPosts.astro";
import Social from "@/components/sections/Social.astro";
import { getEntry } from "astro:content";

const homepage = await getEntry("homepage", "index");
const { banner, about, explore_categories, numbers,videos, gaming, skills, social } = homepage.data;
---

<script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
<script>
  import { login, logout, handleCallback, getAuth0Client, callProtectedEndpoint } from '../../src/lib/utils/client-auth';

  interface Auth0Profile {
    name: string;
    picture: string;
  }

  interface DOMElements {
    loginButton: HTMLElement;
    logoutButton: HTMLElement;
    profileElement: HTMLElement;
    testButton: HTMLElement;
  }

  async function updateUI(): Promise<void> {
    const auth0Client = await getAuth0Client();
    const isAuthenticated = await auth0Client.isAuthenticated();
    const userProfile = await auth0Client.getUser<Auth0Profile>();

    const elements: DOMElements = {
      loginButton: document.getElementById("login") as HTMLElement,
      logoutButton: document.getElementById("logout") as HTMLElement,
      profileElement: document.getElementById("profile") as HTMLElement,
      testButton: document.getElementById("test-function") as HTMLElement
    };

    if (isAuthenticated && userProfile) {
      elements.loginButton.style.display = "none";
      elements.logoutButton.style.display = "block";
      elements.profileElement.style.display = "block";
      elements.profileElement.innerHTML = `
        <p>${userProfile.name}</p>
        <img src="${userProfile.picture}" alt="Profile" />
      `;
    } else {
      elements.loginButton.style.display = "block";
      elements.logoutButton.style.display = "none";
      elements.profileElement.style.display = "none";
    }
  }

  function attachEventListeners(): void {
    document.getElementById('login')?.addEventListener('click', login);
    document.getElementById('logout')?.addEventListener('click', logout);

    document.getElementById('test-function')?.addEventListener('click', async () => {
      try {
        const result = await callProtectedEndpoint('/.netlify/functions/auth-gated-function');
        console.log('Function response:', result);
        alert(JSON.stringify(result, null, 2));
      } catch (error: unknown) {
        if (error instanceof Error) {
          console.error('Error details:', error);
          alert(`Error calling function: ${error.message}`);
        } else {
          console.error('Unknown error:', error);
          alert('An unknown error occurred');
        }
      }
    });
  }

  if (location.search.includes("code=") && location.search.includes("state=")) {
    await handleCallback();
    attachEventListeners();
    await updateUI();
  } else {
    attachEventListeners();
    await updateUI();
  }
</script>
<Base>

  <main class="test">
    <div id="auth0-login-container">
      <button id="login">Log In</button>
      <button id="logout" style="display: none">Log Out</button>
      <button id="test-function">Test Function</button>
    </div>
    <div id="profile" style="display: none">
      <h2>Profile</h2>
      <pre id="profile-data"></pre>
    </div>
  </main>

  <!-- banner -->

  <Banner banner={banner} />
  <About about={about} />
  <Skills skills={skills} />
  <ExploreCategories explore_categories={explore_categories} />
  <Preview videos={videos}/>
  <Number numbers={numbers} />
  <PreviewBlog/>
  <Social social={social}/>
</Base>

<style>
  .test {
    position: absolute;
    z-index: 9999;
    background-color: white;
    top: 100px;
  }
</style>
